

## Database Schema Spec (Multi-Game Ready, PUBG First)

### Goal

Store esports tournaments + matches + rosters + player match stats in a scalable way:

* Supports multiple games via `game_id` (start with `pubg`)
* Rosters are **tournament-scoped**
* Matches are **tournament-scoped**
* Players/Teams are **game-scoped**
* `match_id` is the primary key for match details; other match tables reference it.

---

## Core Entities and Relationships

### 1) `games` (root list of supported games)

* **Purpose:** list of games in platform
* **Primary Key:** `game_id` (string like `pubg`, `cs2`, `valorant`)

**Relationships**

* `tournaments.game_id` → `games.game_id`
* `teams.game_id` → `games.game_id`
* `players.game_id` → `games.game_id`
* `match_information.game_id` → `games.game_id`

---

### 2) `tournaments`

* **Purpose:** a tournament belongs to a game
* **Primary Key:** `tournament_id`
* **FK:** `game_id` → `games(game_id)`

**Important fields**

* `name`, `region`, `start_date`, `end_date`

---

### 3) `teams` (scoped per game)

* **Purpose:** team master data
* **Primary Key:** `(game_id, team_id)` composite
* This prevents team id collisions between different games.

**Fields**

* `team_id`, `game_id`, `team_name`, `region`

---

### 4) `players` (scoped per game)

* **Purpose:** player master data
* **Primary Key:** `(game_id, player_id)` composite
* Prevents collisions across games.

**Fields**

* `player_id`, `game_id`, `player_name`

---

## Tournament-Scoped Rosters

### 5) `tournament_rosters`

* **Purpose:** snapshot of a team’s roster **for a specific tournament**
* **Primary Key:** `roster_id` (internal ID, generated by app)
* **FKs:**

  * `tournament_id` → `tournaments(tournament_id)`
  * `(game_id, team_id)` → `teams(game_id, team_id)`
* **Uniqueness:**

  * `UNIQUE (tournament_id, team_id)` ensures 1 roster per team per tournament.

**Meaning**

> One team can have different rosters across tournaments. Rosters are not global.

---

### 6) `roster_players`

* **Purpose:** lineup: which players are in a tournament roster
* **Primary Key:** `(roster_id, player_id)`
* **FKs:**

  * `roster_id` → `tournament_rosters(roster_id)`
  * `(game_id, player_id)` → `players(game_id, player_id)`

**Meaning**

> Roster → many players. Player can appear in multiple rosters/tournaments.

---

## Match Data

### 7) `match_information` (match master table)

* **Purpose:** one row per match (PK = match_id)
* **Primary Key:** `match_id`
* **FKs:**

  * `game_id` → `games(game_id)`
  * `tournament_id` → `tournaments(tournament_id)`
* Stores match metadata fields from PUBG API:

  * `created_at_api`, `duration`, `game_mode`, `map_name`, `match_type`, `shard_id`, etc.
  * Optional `tags` and `stats` as JSONB for small extra fields
* `updated_at` is auto-maintained by trigger on update

**Meaning**

> `match_id` is the single source of truth for match details; other match tables reference it.

---

### 8) `match_rosters` (which rosters played a match)

* **Purpose:** join table connecting matches ↔ tournament_rosters
* **Primary Key:** `(match_id, roster_id)`
* **FKs:**

  * `match_id` → `match_information(match_id)`
  * `roster_id` → `tournament_rosters(roster_id)`
* Stores placement:

  * `rank`, `won`

**Meaning**

> This is the “glue” that links tournament-scoped rosters to matches.

---

### 9) `match_player_stats` (player performance in a match)

* **Purpose:** per-player per-match stats (kills, assists, damage, etc.)
* **Primary Key:** `(match_id, player_id)`
* **FKs:**

  * `match_id` → `match_information(match_id)`
  * `(game_id, player_id)` → `players(game_id, player_id)`
  * `roster_id` → `tournament_rosters(roster_id)` (nullable)
* Stores many PUBG stats columns (`kills`, `assists`, `damage_dealt`, `time_survived`, `win_place`, …)

**Meaning**

> Enables leaderboards, per match stats tables, analytics.

---

### 10) `match_assets` (optional)

* **Purpose:** telemetry or replay URLs from API
* **Primary Key:** `asset_id`
* **FK:**

  * `match_id` → `match_information(match_id)`
  * `game_id` → `games(game_id)`
* Fields: `url`, `name`, `description`, `created_at_api`

---

## Expected Workflow (app logic)

### Admin flow

1. Create tournament (tournaments)
2. Create/add teams (teams)
3. Create/add players (players)
4. For each tournament: create rosters for teams (tournament_rosters)
5. Assign players to rosters (roster_players)

### Match ingestion flow (from API JSON)

1. Insert/update `match_information` using `match_id`
2. Insert match assets into `match_assets`
3. Insert match results:

   * map API roster/teamId to internal `tournament_rosters.roster_id`
   * insert into `match_rosters` with rank/won
4. Insert participants stats into `match_player_stats`:

   * ensure players exist in `players`
   * link to `roster_id` when possible

---

## Notes for PUBG

* PUBG API rosters sometimes have `teamId` numeric. Store that as `team_id` (TEXT) in `teams`.
* `player_id` from PUBG is typically like `account.xxxxx`. Store as TEXT.

---

## Minimal Query Examples

### Get match with roster results

* match_information + match_rosters + tournament_rosters + teams

### Get leaderboard for a tournament (total kills)

* join match_information → match_player_stats
* filter by tournament_id
* group by player_id / roster_id

-